<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ 2026</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-color: #ffffff;
            --accent-color: #00d2ff;
            --success-color: #00ff88;
            --input-bg: rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: 'Tajawal', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72, #2a5298, #0f2027);
            color: var(--text-color);
            min-height: 100vh;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø²Ø¬Ø§Ø¬ */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            transition: 0.3s;
        }

        /* Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .dashboard-stats {
            display: flex;
            justify-content: space-around;
            text-align: center;
            margin-bottom: 10px;
        }
        .stat-box h3 { margin: 0; font-size: 2em; color: var(--accent-color); }
        .stat-box p { margin: 0; color: #ccc; font-size: 0.9em; }

        /* Ø§Ù„Ø­Ù‚ÙˆÙ„ */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        /* Ø­Ù‚Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª */
        .full-width { grid-column: 1 / -1; }
        
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9em; }
        
        input, select, textarea {
            width: 90%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: var(--input-bg);
            color: white;
            outline: none;
            font-family: 'Tajawal', sans-serif;
        }
        
        input:focus, textarea:focus { border-color: var(--accent-color); box-shadow: 0 0 10px rgba(0, 210, 255, 0.3); }

        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .table-container { overflow-x: auto; border-radius: 15px; background: rgba(0,0,0,0.2); }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th, td { padding: 8px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        /* Ù…ÙŠØ²Ø© Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© */
        .row-header { cursor: pointer; transition: 0.2s; user-select: none; }
        .row-header:hover { color: var(--success-color); background: rgba(255,255,255,0.1); }
        .row-header::after { content: ' ğŸ”½'; font-size: 0.7em; opacity: 0.5; }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ´ÙŠÙƒ */
        .check-btn {
            width: 28px; height: 28px; border-radius: 6px; border: 2px solid #555;
            background: transparent; cursor: pointer; display: inline-block;
        }
        .check-btn.checked {
            background: var(--success-color); border-color: var(--success-color);
            box-shadow: 0 0 8px var(--success-color);
        }
        .check-btn.checked::after { content: 'âœ”'; color: #000; font-weight: bold; display: flex; justify-content: center; align-items: center; height: 100%; }

        /* Ø§Ù„Ø¨Ø­Ø« */
        .search-area { position: relative; margin-bottom: 20px; }
        .search-results {
            position: absolute; top: 100%; width: 95%; left: 2.5%;
            background: #1a1a2e; border: 1px solid #444; z-index: 100;
            max-height: 250px; overflow-y: auto; display: none; border-radius: 0 0 10px 10px;
        }
        .search-item { padding: 12px; border-bottom: 1px solid #333; cursor: pointer; }
        .search-item:hover { background: var(--accent-color); color: #000; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 20px; }
        button {
            padding: 10px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
            font-family: 'Tajawal'; transition: transform 0.2s;
        }
        button:active { transform: scale(0.95); }
        .btn-save { background: #00b894; color: white; }
        .btn-new { background: #0984e3; color: white; }
        .btn-backup { background: #6c5ce7; color: white; }
        .btn-print { background: #e17055; color: white; }
        .btn-del { background: #d63031; color: white; }

        /* --- ØªØ®ØµÙŠØµ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (ÙˆØµÙ„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…) --- */
        @media print {
            body { background: white; color: black; padding: 0; }
            .glass-panel { box-shadow: none; border: 1px solid #000; background: white; border-radius: 0; }
            .actions, .search-area, .dashboard-stats, #backupControls { display: none !important; }
            input, textarea { border: none; background: transparent; color: black; padding: 0; width: auto; font-weight: bold; }
            table { border: 1px solid #000; color: black; }
            th, td { border: 1px solid #000; color: black; }
            th { background-color: #eee !important; -webkit-print-color-adjust: exact; }
            .check-btn { border: 1px solid #000; }
            .check-btn.checked { background: #000 !important; -webkit-print-color-adjust: exact; }
            .check-btn.checked::after { color: white; }
            
            /* ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„ÙˆØµÙ„ */
            .print-header { display: block !important; text-align: center; margin-bottom: 20px; border-bottom: 2px dashed #000; padding-bottom: 10px; }
            h2 { font-size: 1.2em; }
        }
        .print-header { display: none; }
    </style>
</head>
<body>

    <div class="glass-panel">
        <div class="dashboard-stats">
            <div class="stat-box">
                <h3 id="totalFamilies">0</h3>
                <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹ÙˆØ§Ø¦Ù„</p>
            </div>
            <div class="stat-box">
                <h3 id="totalIndividuals">0</h3>
                <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙØ±Ø§Ø¯</p>
            </div>
            <div class="stat-box">
                <h3 id="dateToday">--</h3>
                <p>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</p>
            </div>
        </div>
        <div class="search-area" style="text-align: center;">
            <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©..." style="width: 60%; text-align: center;">
            <div id="searchResults" class="search-results"></div>
        </div>
    </div>

    <div class="glass-panel" id="printArea">
        <div class="print-header">
            <h1>ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¬Ø§Ø±Ø© - ÙˆØµÙ„ ØªØ¬Ù‡ÙŠØ² ÙˆÙƒÙŠÙ„</h1>
            <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: <span id="printDate"></span></p>
        </div>

        <h2 style="text-align: center; margin-bottom: 20px;">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© 2026</h2>
        
        <div class="form-grid">
            <div>
                <label>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ†ÙŠØ©</label>
                <input type="text" id="cardNumber">
            </div>
            <div>
                <label>Ø§Ø³Ù… Ø±Ø¨ Ø§Ù„Ø£Ø³Ø±Ø©</label>
                <input type="text" id="headName">
            </div>
            <div>
                <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙØ±Ø§Ø¯ (Ø§Ù„ÙƒÙ„ÙŠ)</label>
                <input type="number" id="familyCount" value="0">
            </div>
            <div>
                <label>Ù…Ø³ØªØ­Ù‚ÙŠÙ†</label>
                <input type="number" id="eligibleCount" value="0">
            </div>
            <div>
                <label>Ù…Ø­Ø¬ÙˆØ¨ÙŠÙ†</label>
                <input type="number" id="blockedCount" value="0">
            </div>
            <div>
                <label>Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„</label>
                <input type="text" id="agentName" value="Ø³Ø§Ø¬Ø¯Ø© ÙƒØ±Ø¯ÙŠ Ø¹Ù„ÙŠ">
            </div>
            <div class="full-width">
                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆÙƒÙŠÙ„</label>
                <textarea id="notes" rows="2" placeholder="Ø§ÙƒØªØ¨ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ù†Ø§ (Ù…Ø«Ù„: Ù†Ù‚Øµ Ù…ÙˆØ§Ø¯ØŒ Ù…Ø³Ø§ÙØ±...)"></textarea>
            </div>
        </div>

        <div class="table-container">
            <table id="rationTable">
                <thead>
                    <tr>
                        <th style="width: 15%">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                        <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th>
                        <th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div style="display: none; justify-content: space-between; margin-top: 30px;" class="print-only">
            <div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„ÙˆÙƒÙŠÙ„</div>
            <div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
        </div>
    </div>

    <div class="actions">
        <button class="btn-new" onclick="clearForm()">ğŸ“„ Ø¬Ø¯ÙŠØ¯</button>
        <button class="btn-save" onclick="saveData()">ğŸ’¾ Ø­ÙØ¸</button>
        <button class="btn-print" onclick="printReceipt()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙˆØµÙ„</button>
        <button class="btn-del" onclick="deleteCurrent()">ğŸ—‘ï¸ Ø­Ø°Ù</button>
    </div>

    <div class="glass-panel" id="backupControls" style="text-align: center; margin-top: 20px;">
        <h4 style="margin-top: 0;">ğŸ› ï¸ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h4>
        <button class="btn-backup" onclick="exportData()">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
        <button class="btn-backup" onclick="document.getElementById('fileInput').click()">â¬†ï¸ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø©</button>
        <input type="file" id="fileInput" style="display: none" onchange="importData(this)">
    </div>

    <script>
        const items = ["Ø§Ù„Ø±Ø²", "Ø§Ù„Ø³ÙƒØ±", "Ø§Ù„Ø²ÙŠØª", "Ø§Ù„Ù…Ø¹Ø¬ÙˆÙ†", "Ø§Ù„Ø¨Ù‚ÙˆÙ„ÙŠØ§Øª", "Ø§Ù„Ø·Ø­ÙŠÙ†", "Ø±Ø¹Ø§ÙŠØ©"];
        let currentId = null;

        window.onload = function() {
            renderTable();
            updateDashboard();
            document.getElementById('dateToday').innerText = new Date().toLocaleDateString('ar-IQ');
            document.getElementById('printDate').innerText = new Date().toLocaleDateString('ar-IQ');
            document.getElementById('searchInput').addEventListener('input', handleSearch);
        };

        // Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ Ù…ÙŠØ²Ø© Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø£Ø³
        function renderTable() {
            const tbody = document.querySelector('#rationTable tbody');
            tbody.innerHTML = '';
            items.forEach((item, rIndex) => {
                let row = `<tr>
                    <td class="row-header" onclick="toggleRow(${rIndex})" title="Ø§Ø¶ØºØ· Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„">${item}</td>`;
                for (let i = 1; i <= 12; i++) {
                    row += `<td><div class="check-btn" id="cell_${rIndex}_${i}" onclick="toggleCheck(this)"></div></td>`;
                }
                row += `</tr>`;
                tbody.innerHTML += row;
            });
        }

        function toggleCheck(el) { el.classList.toggle('checked'); }

        // Ù…ÙŠØ²Ø© 1: ØªØ­Ø¯ÙŠØ¯ ØµÙ ÙƒØ§Ù…Ù„
        function toggleRow(rowIndex) {
            let allChecked = true;
            // ÙØ­Øµ Ù‡Ù„ Ø§Ù„ØµÙ Ù…Ø­Ø¯Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ
            for (let i = 1; i <= 12; i++) {
                if (!document.getElementById(`cell_${rowIndex}_${i}`).classList.contains('checked')) {
                    allChecked = false;
                    break;
                }
            }
            // Ø§Ù„Ø¹ÙƒØ³
            for (let i = 1; i <= 12; i++) {
                const cell = document.getElementById(`cell_${rowIndex}_${i}`);
                if (allChecked) cell.classList.remove('checked');
                else cell.classList.add('checked');
            }
        }

        // Ø§Ù„Ø­ÙØ¸
        function saveData() {
            const name = document.getElementById('headName').value;
            const cardNo = document.getElementById('cardNumber').value;
            if (!name || !cardNo) { alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©'); return; }

            let gridData = {};
            items.forEach((item, rIndex) => {
                for (let c = 1; c <= 12; c++) {
                    if (document.getElementById(`cell_${rIndex}_${c}`).classList.contains('checked')) {
                        gridData[`${rIndex}_${c}`] = true;
                    }
                }
            });

            const record = {
                id: currentId || Date.now(),
                name, cardNo,
                familyCount: document.getElementById('familyCount').value,
                eligibleCount: document.getElementById('eligibleCount').value, // Ø¬Ø¯ÙŠØ¯: Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ­Ù‚ÙŠÙ†
                blockedCount: document.getElementById('blockedCount').value,   // Ø¬Ø¯ÙŠØ¯: Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨ÙŠÙ†
                agentName: document.getElementById('agentName').value,
                notes: document.getElementById('notes').value, 
                grid: gridData,
                updatedAt: new Date().toISOString()
            };

            let allData = JSON.parse(localStorage.getItem('rationData') || '[]');
            if (currentId) allData = allData.filter(d => d.id !== currentId);
            
            allData.push(record);
            localStorage.setItem('rationData', JSON.stringify(allData));
            currentId = record.id;
            
            updateDashboard();
            alert('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸');
        }

        // Ù…ÙŠØ²Ø© 2: ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        function updateDashboard() {
            const allData = JSON.parse(localStorage.getItem('rationData') || '[]');
            document.getElementById('totalFamilies').innerText = allData.length;
            
            let individuals = 0;
            allData.forEach(d => individuals += parseInt(d.familyCount || 0));
            document.getElementById('totalIndividuals').innerText = individuals;
        }

        // Ù…ÙŠØ²Ø© 4: Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ (ØªØµØ¯ÙŠØ±)
        function exportData() {
            const data = localStorage.getItem('rationData');
            if (!data) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ration_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        // Ù…ÙŠØ²Ø© 4: Ø§Ø³ØªØ¹Ø§Ø¯Ø© (Ø§Ø³ØªÙŠØ±Ø§Ø¯)
        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    JSON.parse(e.target.result); // Check validity
                    localStorage.setItem('rationData', e.target.result);
                    alert('âœ… ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.');
                    location.reload();
                } catch(err) {
                    alert('âŒ Ù…Ù„Ù Ø®Ø§Ø·Ø¦');
                }
            };
            reader.readAsText(file);
        }

        // Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„
        function handleSearch(e) {
            const q = e.target.value.toLowerCase();
            const res = document.getElementById('searchResults');
            const data = JSON.parse(localStorage.getItem('rationData') || '[]');
            res.innerHTML = '';
            
            if (q.length < 1) { res.style.display = 'none'; return; }

            const filtered = data.filter(d => d.name.includes(q) || d.cardNo.includes(q));
            if (filtered.length > 0) {
                res.style.display = 'block';
                filtered.forEach(d => {
                    const div = document.createElement('div');
                    div.className = 'search-item';
                    div.innerText = `${d.name} (${d.cardNo})`;
                    div.onclick = () => loadRecord(d);
                    res.appendChild(div);
                });
            } else res.style.display = 'none';
        }

        function loadRecord(d) {
            currentId = d.id;
            document.getElementById('headName').value = d.name;
            document.getElementById('cardNumber').value = d.cardNo;
            document.getElementById('familyCount').value = d.familyCount;
            document.getElementById('eligibleCount').value = d.eligibleCount || 0; // Ø¬Ø¯ÙŠØ¯: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ­Ù‚ÙŠÙ†
            document.getElementById('blockedCount').value = d.blockedCount || 0;   // Ø¬Ø¯ÙŠØ¯: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨ÙŠÙ†
            document.getElementById('agentName').value = d.agentName;
            document.getElementById('notes').value = d.notes || ''; 
            
            document.querySelectorAll('.check-btn').forEach(b => b.classList.remove('checked'));
            if (d.grid) {
                for (const k in d.grid) {
                    const cell = document.getElementById(`cell_${k}`);
                    if(cell) cell.classList.add('checked');
                }
            }
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchInput').value = '';
        }

        function clearForm() {
            currentId = null;
            document.getElementById('headName').value = '';
            document.getElementById('cardNumber').value = '';
            document.getElementById('familyCount').value = 0;
            document.getElementById('eligibleCount').value = 0; // Ø¬Ø¯ÙŠØ¯: ØªØµÙÙŠØ± Ø§Ù„Ù…Ø³ØªØ­Ù‚ÙŠÙ†
            document.getElementById('blockedCount').value = 0;  // Ø¬Ø¯ÙŠØ¯: ØªØµÙÙŠØ± Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨ÙŠÙ†
            document.getElementById('notes').value = '';
            document.querySelectorAll('.check-btn').forEach(b => b.classList.remove('checked'));
        }
        
        function deleteCurrent() {
            if(!currentId || !confirm('Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;
            let data = JSON.parse(localStorage.getItem('rationData') || '[]');
            data = data.filter(d => d.id !== currentId);
            localStorage.setItem('rationData', JSON.stringify(data));
            clearForm();
            updateDashboard();
            alert('ØªÙ… Ø§Ù„Ø­Ø°Ù');
        }

        // Ù…ÙŠØ²Ø© 5: Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„
        function printReceipt() {
            window.print();
        }
    </script>
</body>
</html>
